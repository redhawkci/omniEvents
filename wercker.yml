build:
  box: redhawkci/rpmbuild:el6
  steps:
    - script:
        name: update installed packages
        code: yum update -y

    - script:
        name: install dependencies
        code: yum-builddep -y omniEvents.spec

    - script:
        name: build packages
        code: |
          tar --transform 's,^\.,omniEvents-2.7.0,' -czvf /root/rpmbuild/SOURCES/omniEvents-2.7.0.tar.gz .
          rpmbuild -bb omniEvents.spec

    - script:
        name: copy output
        code: |
          cp -rv /root/rpmbuild/RPMS/x86_64/* "$WERCKER_OUTPUT_DIR"
          #Temporarily, grab the omniORBpy packages from REDHAWK 1.10.2
          #yum repo so we can deploy a redhawk-deps yum repo
          yum install -y createrepo
          cd $WERCKER_OUTPUT_DIR
          wget http://yum.axiosengineering.com/redhawk/1.10.2/el6/x86_64/omniORBpy-debuginfo-3.6-3.el6.x86_64.rpm
          wget http://yum.axiosengineering.com/redhawk/1.10.2/el6/x86_64/omniORBpy-devel-3.6-3.el6.noarch.rpm
          wget http://yum.axiosengineering.com/redhawk/1.10.2/el6/x86_64/omniORBpy-libs-3.6-3.el6.x86_64.rpm
          wget http://yum.axiosengineering.com/redhawk/1.10.2/el6/x86_64/python-omniORB-3.6-3.el6.noarch.rpm
          createrepo .

deploy:
    box: python
    steps:
    - s3sync:
        source-dir: .
        bucket-url: $AWS_BUCKET_URL
        key-id: $AWS_ACCESS_KEY_ID
        key-secret: $AWS_SECRET_ACCESS_KEY
